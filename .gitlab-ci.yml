include:
 - remote: 'https://gitlab.freedesktop.org/freedesktop/ci-templates/-/raw/11fe3571905faceef51c7253dfdaf79ece8cf062/templates/fedora.yml'

variables:
  FDO_UPSTREAM_REPO: gnome/gnome-initial-setup

stages:
  - prepare
  - build

.fedora.container.common:
  variables:
    # When branching a stable release, change 'main'
    # to the release number/branch to ensure that
    # a new image will be created, tailored for the
    # stable branch.
    FDO_DISTRIBUTION_TAG: '2022-05-27.1-main'
    FDO_DISTRIBUTION_VERSION: 36

# See also https://gitlab.freedesktop.org/freedesktop/ci-templates
build.container.fedora@x86_64:
  extends:
  - '.fdo.container-build@fedora'
  - '.fedora.container.common'
  stage: 'prepare'
  variables:
    # no need to pull the whole tree for rebuilding the image
    GIT_STRATEGY: none
    # Expiry sets fdo.expires on the image
    FDO_EXPIRES_AFTER: 8w
    FDO_DISTRIBUTION_PACKAGES: >-
      @c-development
      @development-tools
      accountsservice-devel
      ccache
      cheese-libs-devel
      cheese-libs-devel
      desktop-file-utils
      flatpak-devel
      fontconfig-devel
      gdm-devel
      geoclue2-devel
      geocode-glib-devel
      git
      glib2-devel
      gnome-desktop4-devel
      gnome-online-accounts-devel
      gobject-introspection-devel
      gsettings-desktop-schemas-devel
      gstreamer1-devel
      gtk-doc
      gtk3-devel
      gtk4-devel
      ibus-devel
      iso-codes-devel
      krb5-devel
      libgweather4-devel
      libhandy-devel
      libnma-devel
      libpwquality-devel
      libseccomp-devel
      libsecret-devel
      malcontent-ui-devel
      meson
      NetworkManager-libnm-devel
      ninja-build
      polkit-devel
      rest-devel
      webkit2gtk3-devel
      xkeyboard-config-devel

.job_template: &job_definition
  extends:
    - '.fdo.distribution-image@fedora'
    - '.fedora.container.common'

  stage: build

  script:
    # In general, we would like warnings to be fatal. However, code copied from
    # gnome-control-center uses many deprecated functions. Until we have a good
    # answer to sharing that code (#68), make those warnings non-fatal.
    - meson
        -Dsystemd=${EXPLICIT_FEATURES}
        -Dsoup2=true
        --auto-features ${AUTO_FEATURES}
        ${OPTIONS}
        -Dwerror=true -Dc_args=-Wno-error=deprecated-declarations
        ${EXTRA_PARAMETERS}
        --wrap-mode=nodownload
        _build
        .
    - cd _build
    - ninja -v
    # Check that strings can be extracted
    - ninja -v gnome-initial-setup-pot
    # Check the package can be installed
    - DESTDIR=$(mktemp -d) ninja -v install
    - meson test
  artifacts:
    when: on_failure
    name: "gnome-initial-setup-${CI_COMMIT_REF_NAME}-${CI_JOB_NAME}"
    paths:
      - "${CI_PROJECT_DIR}/_build/meson-logs"

build-minimal:
  <<: *job_definition
  variables:
    EXPLICIT_FEATURES: 'false'
    AUTO_FEATURES: 'disabled'
    OPTIONS: ''

build-maximal:
  <<: *job_definition
  variables:
    EXPLICIT_FEATURES: 'true'
    AUTO_FEATURES: 'enabled'
    OPTIONS: '-Dvendor-conf-file=/var/lib/weird-vendor-specific-path.ini'
